# Story 3.1: Tick-Based Animation Foundation

## Status: Draft

**Epic:** 3 - Animation & Coordination System  
**Estimated Effort:** 2 days  
**Priority:** High - Foundation for all Epic 3 animation capabilities  
**Prerequisites:** Epic 2 complete (✅), Tick-based system validated (✅ 28/28 tests passing)

## Story

- As a developer
- I need tick-based animations integrated with all widget types
- so that I can create deterministic, multi-core safe animations with perfect timing precision

## Acceptance Criteria (ACs)

1. **AC1:** All core widgets (Text, Image, ProgressBar, Shape, Canvas) use tick-based animation system
2. **AC2:** Widget animation methods accept tick parameters instead of time parameters
3. **AC3:** Rendering engine advances animation tick once per render cycle
4. **AC4:** Animation state computation is deterministic across multiple executions
5. **AC5:** Tick-based easing functions provide smooth animation curves
6. **AC6:** Animation definitions use tick durations instead of time durations
7. **AC7:** Backward compatibility layer converts time-based animations to tick-based

## Tasks / Subtasks

- [ ] Task 1: Integrate TickAnimationEngine with Rendering System (AC: 3, 4)
  - [ ] Modify rendering engine to advance animation tick per frame
  - [ ] Replace time.time() calls with tick-based timing in render loop
  - [ ] Add tick advancement to main rendering cycle
  - [ ] Implement tick-based frame timing coordination
  - [ ] Add determinism validation to rendering pipeline
  - [ ] Create rendering engine integration tests

- [ ] Task 2: Update Widget Base Classes for Tick-Based Animation (AC: 1, 2)
  - [ ] Modify Widget.update_animations() to accept tick parameter
  - [ ] Replace time-based animation state with tick-based state
  - [ ] Update widget animation lifecycle methods for tick timing
  - [ ] Add tick-based animation state management to widgets
  - [ ] Implement widget animation determinism validation
  - [ ] Create widget tick animation test suite

- [ ] Task 3: Migrate Core Widget Animation Methods (AC: 1, 2, 5)
  - [ ] Update TextWidget animation methods to use tick parameters
  - [ ] Update ImageWidget animation methods to use tick parameters
  - [ ] Update ProgressBarWidget animation methods to use tick parameters
  - [ ] Update ShapeWidget animation methods to use tick parameters
  - [ ] Update CanvasWidget animation methods to use tick parameters
  - [ ] Validate all widget animations use tick-based easing functions

- [ ] Task 4: Implement Tick-Based Animation API (AC: 6, 7)
  - [ ] Create tick-based animation creation utilities
  - [ ] Implement tick duration specification in animation definitions
  - [ ] Add tick-to-time conversion utilities for user-facing APIs
  - [ ] Create backward compatibility layer for time-based animations
  - [ ] Implement animation definition validation for tick parameters
  - [ ] Create comprehensive animation API test suite

- [ ] Task 5: Validate Deterministic Behavior (AC: 4)
  - [ ] Implement cross-execution determinism validation
  - [ ] Create determinism test suite for all widget animations
  - [ ] Add performance benchmarks for tick-based animations
  - [ ] Validate identical results across multiple animation runs
  - [ ] Create determinism debugging tools
  - [ ] Document determinism guarantees and limitations

- [ ] Task 6: Performance Optimization and Integration (AC: 3, 4, 5)
  - [ ] Optimize tick advancement performance in rendering loop
  - [ ] Implement efficient tick-based state computation
  - [ ] Add animation performance monitoring and metrics
  - [ ] Optimize easing function calculations for tick-based timing
  - [ ] Create performance benchmarks for 60fps targets
  - [ ] Validate performance targets on Pi Zero 2W

## Dev Technical Guidance

### Architecture Foundation

**Tick-Based System Integration:** This story integrates the proven tick-based animation system (✅ 28/28 tests passing) with the existing widget architecture from Epic 2. The tick-based system is already implemented in `src/tinydisplay/animation/tick_based.py` and provides deterministic, multi-core safe animations.

**Key Integration Points:**
1. **Rendering Engine**: `src/tinydisplay/rendering/engine.py` - Add tick advancement
2. **Widget Base Classes**: `src/tinydisplay/widgets/base.py` - Update animation methods
3. **Core Widgets**: All widgets in `src/tinydisplay/widgets/` - Migrate animation methods
4. **Animation API**: Create user-facing tick-based animation utilities

### Technical Implementation Details

**Rendering Engine Integration:**
```python
# src/tinydisplay/rendering/engine.py
class RenderingEngine:
    def __init__(self):
        # Add tick animation engine
        self.tick_animation_engine = TickAnimationEngine()
        self.current_tick = 0
    
    def _render_loop(self) -> None:
        """Main rendering loop with tick advancement."""
        while not self._stop_event.is_set():
            # Advance animation tick once per render cycle
            self.tick_animation_engine.advance_tick()
            self.current_tick = self.tick_animation_engine.current_tick
            
            # Compute current frame state using current tick
            frame_state = self.tick_animation_engine.compute_frame_state(self.current_tick)
            
            # Apply frame state to widgets and render
            self._apply_frame_state_to_widgets(frame_state)
            self._render_frame()
            
            # Real-time only for FPS control, not animation logic
            if self._config.vsync_enabled:
                self._frame_timer.wait_for_next_frame()
```

**Widget Base Class Updates:**
```python
# src/tinydisplay/widgets/base.py
class Widget:
    def __init__(self, widget_id: Optional[str] = None):
        super().__init__(widget_id)
        self._tick_animations: Dict[str, str] = {}  # animation_name -> animation_id
        self._animation_start_tick: Optional[int] = None
        self._current_animation_state: Optional[TickAnimationState] = None
    
    def update_animations(self, current_tick: int) -> None:
        """Update animations using current tick instead of time.time()"""
        if not self._tick_animations:
            return
        
        # Get animation state from tick animation engine
        for animation_name, animation_id in self._tick_animations.items():
            animation_state = self.get_animation_engine().compute_animation_state(
                animation_id, current_tick
            )
            if animation_state:
                self._apply_animation_state(animation_state)
    
    def start_tick_animation(self, animation_name: str, animation_def: TickAnimationDefinition) -> bool:
        """Start tick-based animation on widget."""
        animation_id = f"{self.widget_id}_{animation_name}"
        engine = self.get_animation_engine()
        
        engine.add_animation(animation_id, animation_def)
        success = engine.start_animation_at(animation_id, engine.current_tick)
        
        if success:
            self._tick_animations[animation_name] = animation_id
        
        return success
```

**Animation Creation Utilities:**
```python
# src/tinydisplay/animation/utilities.py
def create_widget_fade_animation(widget: Widget, duration_ticks: int, 
                                start_opacity: float = 0.0, end_opacity: float = 1.0,
                                easing: str = "ease_out") -> TickAnimationDefinition:
    """Create tick-based fade animation for widget."""
    current_pos = widget.get_position()
    
    start_state = TickAnimationState(
        tick=0,
        position=current_pos,
        opacity=start_opacity
    )
    
    end_state = TickAnimationState(
        tick=duration_ticks,
        position=current_pos,
        opacity=end_opacity
    )
    
    return TickAnimationDefinition(
        start_tick=0,
        duration_ticks=duration_ticks,
        start_state=start_state,
        end_state=end_state,
        easing=easing
    )

# Backward compatibility layer
def create_time_based_animation(duration_seconds: float, fps: int = 60, **kwargs) -> TickAnimationDefinition:
    """Convert time-based animation to tick-based animation."""
    duration_ticks = int(duration_seconds * fps)
    return create_widget_fade_animation(duration_ticks=duration_ticks, **kwargs)
```

### Key Architecture Documents

**Primary References:**
- **`docs/tick-based-api-design.md`** - Complete API specification (1,281 lines)
- **`src/tinydisplay/animation/tick_based.py`** - Proven implementation (✅ 28/28 tests)
- **`docs/widget-migration-strategy.md`** - All-at-once migration approach
- **`docs/project-structure.md`** - File organization and integration points

**Integration Strategy:**
1. **Phase 1**: Rendering engine integration with tick advancement
2. **Phase 2**: Widget base class updates for tick-based animation methods
3. **Phase 3**: Core widget migration to tick-based animations
4. **Phase 4**: Animation API creation and backward compatibility
5. **Phase 5**: Determinism validation and performance optimization

### Performance Requirements

**Target Performance (from Epic 3):**
- **60fps sustained** on Raspberry Pi Zero 2W
- **Deterministic behavior** across multiple executions
- **Sub-microsecond** animation state computation (proven in existing tests)
- **Memory efficient** animation state management

**Validation Requirements:**
- All animations must produce identical results across multiple runs
- Performance benchmarks must meet 60fps targets
- Memory usage must stay within Epic 2 established limits (<100MB)
- Cross-core determinism must be validated for future multi-core work

### Project Structure Alignment

**File Modifications Required:**
```
src/tinydisplay/
├── rendering/
│   └── engine.py              # Add tick advancement to render loop
├── widgets/
│   ├── base.py               # Update animation methods for tick parameters
│   ├── text.py               # Migrate text widget animations
│   ├── image.py              # Migrate image widget animations
│   ├── progress.py           # Migrate progress bar animations
│   ├── shapes.py             # Migrate shape widget animations
│   └── collections.py        # Migrate canvas/collection animations
├── animation/
│   ├── utilities.py          # NEW: Animation creation utilities
│   ├── compatibility.py      # NEW: Backward compatibility layer
│   └── tick_based.py         # EXISTING: Core tick system (no changes)
└── utils/
    └── animation_helpers.py   # NEW: Helper functions for widget integration
```

**Test Files Required:**
```
tests/
├── integration/
│   ├── tick_animation_integration/  # NEW: Integration test suite
│   └── widget_animation_migration/  # NEW: Migration validation tests
├── unit/
│   ├── animation/
│   │   ├── test_tick_integration.py    # NEW: Tick integration tests
│   │   └── test_animation_utilities.py # NEW: Utility function tests
│   └── widgets/
│       └── test_tick_animations.py     # NEW: Widget tick animation tests
└── performance/
    └── tick_animation_benchmarks.py    # NEW: Performance validation
```

## Story Progress Notes

### Agent Model Used: `Jimmy (Technical Product Owner)`

### Completion Notes List

{Implementation notes will be added during development}

### Change Log

- **Initial Creation**: Story 3.1 created with comprehensive technical guidance
- **Epic 3 Integration**: Aligned with proven tick-based architecture and Epic 2 widget foundation 